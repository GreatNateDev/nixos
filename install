clear
# START BLOCK
echo "Starting Installer..."
TARGET_USER="$USER"
TARGET_HOSTNAME="$(hostname)"
TARGET_FULLNAME=$(getent passwd "$TARGET_USER" | cut -d: -f5 | cut -d, -f1)
if [ -z "$TARGET_FULLNAME" ]; then
  TARGET_FULLNAME="$TARGET_USER"
fi
echo "Detected configuration:"
echo "  Username: $TARGET_USER"
echo "  Fullname: $TARGET_FULLNAME"
echo "  Hostname: $TARGET_HOSTNAME"
read -p "Continue with this configuration? (y/N): " confirm
if [ "$confirm" != "y" ]; then
  echo "Installation cancelled."
  exit 1
fi
nix-env -iA nixos.lolcat
clear
# INTRO BLOCK
lolcat <<"EOF"
███    ██  █████  ████████ ███████ ███████     ███    ██ ██ ██   ██  ██████  ███████     ██ ███    ██ ███████ ████████  █████  ██      ██      ███████ ██████
████   ██ ██   ██    ██    ██      ██          ████   ██ ██  ██ ██  ██    ██ ██          ██ ████   ██ ██         ██    ██   ██ ██      ██      ██      ██   ██
██ ██  ██ ███████    ██    █████   ███████     ██ ██  ██ ██   ███   ██    ██ ███████     ██ ██ ██  ██ ███████    ██    ███████ ██      ██      █████   ██████
██  ██ ██ ██   ██    ██    ██           ██     ██  ██ ██ ██  ██ ██  ██    ██      ██     ██ ██  ██ ██      ██    ██    ██   ██ ██      ██      ██      ██   ██
██   ████ ██   ██    ██    ███████ ███████     ██   ████ ██ ██   ██  ██████  ███████     ██ ██   ████ ███████    ██    ██   ██ ███████ ███████ ███████ ██   ██



EOF
read -p "Git User: " TARGET_GITUSER
read -p "Git Email: " TARGET_GITEMAIL
sudo nixos-generate-config 2>/dev/null
nix-env -e lolcat 2>/dev/null
# INSTALLING BLOCK
echo "Installing..."
mkdir -p ~/.config/nixos
mv ~/nixos/.git ~/.config/nixos/
mv ~/nixos/.gitignore ~/.config/nixos/
mv ~/nixos/* ~/.config/nixos/
cat >~/.config/nixos/nix/env.nix <<EOF
{
  username = "$TARGET_USER";
  hostname = "$TARGET_HOSTNAME";
  fullname = "$TARGET_FULLNAME";
  gituser = "$TARGET_GITUSER";
  gitemail = "$TARGET_GITEMAIL";
  folder = "vbg";
  imgbb = "";
}
EOF
echo "{ ... }: {}" >~/.config/nixos/nix/custom.nix
echo "{ ... }: {}" >~/.config/nixos/nix/custom-home.nix
rmdir ~/nixos ~/Desktop ~/Documents ~/Downloads ~/Music ~/Pictures ~/Public ~/Templates ~/Videos 2>/dev/null
rm ~/.config/user-dirs.dirs 2>/dev/null
echo "Getting hardware config..."
sudo mv /etc/nixos/hardware-configuration.nix ~/.config/nixos/nix/hardware.nix
echo "Removing old config..."
sudo rm -rf /etc/nixos/
echo "Options..."
# Initialize variables with defaults
GAMING="false"
HACKING="false"
DEV="false"
VPN="false"
SNITCH="false"
SSH="false"
QEMU="false"
read -p "Set Extra Options? (y/N): " confirmop
if [[ "$confirmop" == "y" ]]; then
  read -p "Gaming (y/N): " gamingr
  if [[ "$gamingr" == "y" ]]; then
    GAMING="true"
  fi
    read -p "Hacking (y/N): " hackingr
    if [[ "$hackingr" == "y" ]]; then
    HACKING="true"
    fi
    read -p "Development (y/N): " devr
    if [[ "$devr" == "y" ]]; then
    DEV="true"
    fi
    read -p "VPN (y/N): " vpnr
    if [[ "$vpnr" == "y" ]]; then
    VPN="true"
    fi
    read -p "OpenSnitch (y/N): " snitchr
    if [[ "$snitchr" == "y" ]]; then
    SNITCH="true"
    fi
    read -p "SSH (y/N): " sshr
    if [[ "$sshr" == "y" ]]; then
    SSH="true"
    fi
    read -p "QEMU (y/N): " qemur
    if [[ "$qemur" == "y" ]]; then
    QEMU="true"
    fi

cat >~/.config/nixos/nix/options.nix <<EOF
{ config, lib, ... }:

{
  config.hello.enable = false;
  config.gaming.enable = ${GAMING};
  config.hacking.enable = ${HACKING};
  config.development.enable = ${DEV};
  config.vpn.enable = $(VPN);
  config.opensnitch.enable = $(SNITCH);
  config.ssh.enable = $(SSH);
  config.qemu.enable = $(QEMU);
}
EOF
echo 'Rebuilding NixOS...' && sudo nixos-rebuild switch --flake $HOME/.config/nixos/nix --impure --quiet --cores=$(nproc) --max-jobs=$(nproc) && echo Done!
chmod -R +x $HOME/.config/nixos/scripts/
echo "Cleaning up..."
nix-env -e git 2>/dev/null
clear
echo "Script complete. Reboot? (y/N)"
read rebootcon
if [ "$rebootcon" = "y" ]; then
  reboot
else
  echo "Skipping reboot."
  exit 0
fi
