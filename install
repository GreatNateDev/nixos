clear
# START BLOCK
echo "Starting Installer..."
TARGET_USER="$USER"
TARGET_HOSTNAME="$(hostname)"
TARGET_FULLNAME=$(getent passwd "$TARGET_USER" | cut -d: -f5 | cut -d, -f1)
if [ -z "$TARGET_FULLNAME" ]; then
  TARGET_FULLNAME="$TARGET_USER"
fi
echo "Detected configuration:"
echo "  Username: $TARGET_USER"
echo "  Fullname: $TARGET_FULLNAME"
echo "  Hostname: $TARGET_HOSTNAME"
read -p "Continue with this configuration? (y/N): " confirm
if [ "$confirm" != "y" ]; then
  echo "Installation cancelled."
  exit 1
fi
nix-env -iA nixos.lolcat
clear
# INTRO BLOCK
lolcat <<"EOF"
███    ██  █████  ████████ ███████ ███████     ███    ██ ██ ██   ██  ██████  ███████     ██ ███    ██ ███████ ████████  █████  ██      ██      ███████ ██████
████   ██ ██   ██    ██    ██      ██          ████   ██ ██  ██ ██  ██    ██ ██          ██ ████   ██ ██         ██    ██   ██ ██      ██      ██      ██   ██
██ ██  ██ ███████    ██    █████   ███████     ██ ██  ██ ██   ███   ██    ██ ███████     ██ ██ ██  ██ ███████    ██    ███████ ██      ██      █████   ██████
██  ██ ██ ██   ██    ██    ██           ██     ██  ██ ██ ██  ██ ██  ██    ██      ██     ██ ██  ██ ██      ██    ██    ██   ██ ██      ██      ██      ██   ██
██   ████ ██   ██    ██    ███████ ███████     ██   ████ ██ ██   ██  ██████  ███████     ██ ██   ████ ███████    ██    ██   ██ ███████ ███████ ███████ ██   ██



EOF
read -p "Git User: " TARGET_GITUSER
read -p "Git Email: " TARGET_GITEMAIL
read -p "SSID: " TARGET_SSID
read -p "Network Passkey: " TARGET_NETKEY
read -p "Static IP (Leave blank to use DHCP): " TARGET_ADDRESS
read -p "Gateway (the routers ip): " TARGET_GATEWAY
read -p "Server Address (Can be empty but you will lose some features): " TARGET_SERVER
sudo nixos-generate-config 2>/dev/null
nix-env -e lolcat 2>/dev/null
# INSTALLING BLOCK
echo "Installing..."
mkdir -p ~/.config/nixos
mv ~/nixos/.git ~/.config/nixos/
mv ~/nixos/.gitignore ~/.config/nixos/
mv ~/nixos/.gitattributes ~/.config/nixos/
mv ~/nixos/* ~/.config/nixos/
cat >~/.config/nixos/nix/env.nix <<EOF
{
  username = "$TARGET_USER";
  hostname = "$TARGET_HOSTNAME";
  fullname = "$TARGET_FULLNAME";
  gituser = "$TARGET_GITUSER";
  gitemail = "$TARGET_GITEMAIL";
  ssid = "$TARGET_SSID";
  netkey = "$TARGET_NETKEY";
  gateway = $TARGET_GATEWAY;
  address = "$TARGET_ADDRESS";
  server = "$TARGET_SERVER";
  folder = "vbg";
  imgbb = "";
}
EOF
echo "{ ... }: {}" >~/.config/nixos/nix/custom.nix
echo "{ ... }: {}" >~/.config/nixos/nix/custom-home.nix
rmdir ~/nixos ~/Desktop ~/Documents ~/Downloads ~/Music ~/Pictures ~/Public ~/Templates ~/Videos 2>/dev/null
rm ~/.config/user-dirs.dirs 2>/dev/null
echo "Getting hardware config..."
sudo mv /etc/nixos/hardware-configuration.nix ~/.config/nixos/nix/hardware.nix
echo "Removing old config..."
sudo rm -rf /etc/nixos/
cat >~/.config/nixos/nix/options.nix <<EOF
{ ... }:

{
config = {
windowmanager.enable = true;
gaming.enable = false;
hacking.enable = false;
development.enable = false;
vpn.enable = false;
opensnitch.enable = false;
ssh.enable = false;
qemu.enable = false;
font.enable = false;
streaming.enable = false;
gui.enable = false;
airdrop.enable = false;
mpris.enable = false;
entertainment.enable = false;
drawing.enable = false;
};
}
EOF
chmod -R +x $HOME/.config/nixos/scripts/
nano $HOME/.config/nixos/nix/options.nix
echo 'Rebuilding NixOS...' && sudo nixos-rebuild switch --flake $HOME/.config/nixos/nix --impure --quiet --cores=$(nproc) --max-jobs=$(nproc) && echo Done!
echo "Cleaning up..."
nix-env -e git 2>/dev/null
clear
echo "Script complete. Reboot? (y/N)"
read rebootcon
if [ "$rebootcon" = "y" ]; then
  reboot
else
  echo "Skipping reboot."
  exit 0
fi
