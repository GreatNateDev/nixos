clear
# START BLOCK
echo "Starting Installer..."
TARGET_USER="$USER"
TARGET_HOSTNAME="$(hostname)"
TARGET_FULLNAME=$(getent passwd "$TARGET_USER" | cut -d: -f5 | cut -d, -f1)
if [ -z "$TARGET_FULLNAME" ]; then
  TARGET_FULLNAME="$TARGET_USER"
fi
echo "Detected configuration:"
echo "  Username: $TARGET_USER"
echo "  Fullname: $TARGET_FULLNAME"
echo "  Hostname: $TARGET_HOSTNAME"
read -p "Continue with this configuration? (y/N): " confirm
if [ "$confirm" != "y" ]; then
  echo "Installation cancelled."
  exit 1
fi
nix-env -iA nixos.lolcat
clear
# INTRO BLOCK
lolcat <<"EOF"
███    ██  █████  ████████ ███████ ███████     ███    ██ ██ ██   ██  ██████  ███████     ██ ███    ██ ███████ ████████  █████  ██      ██      ███████ ██████
████   ██ ██   ██    ██    ██      ██          ████   ██ ██  ██ ██  ██    ██ ██          ██ ████   ██ ██         ██    ██   ██ ██      ██      ██      ██   ██
██ ██  ██ ███████    ██    █████   ███████     ██ ██  ██ ██   ███   ██    ██ ███████     ██ ██ ██  ██ ███████    ██    ███████ ██      ██      █████   ██████
██  ██ ██ ██   ██    ██    ██           ██     ██  ██ ██ ██  ██ ██  ██    ██      ██     ██ ██  ██ ██      ██    ██    ██   ██ ██      ██      ██      ██   ██
██   ████ ██   ██    ██    ███████ ███████     ██   ████ ██ ██   ██  ██████  ███████     ██ ██   ████ ███████    ██    ██   ██ ███████ ███████ ███████ ██   ██



EOF
read -p "Git User: " TARGET_GITUSER
read -p "Git Email: " TARGET_GITEMAIL
sudo nixos-generate-config 2>/dev/null
nix-env -e lolcat 2>/dev/null
# INSTALLING BLOCK
echo "Installing..."
mkdir -p ~/.config/nixos
mv ~/nixos/.git ~/.config/nixos/
mv ~/nixos/.gitignore ~/.config/nixos/
mv ~/nixos/* ~/.config/nixos/
cat >~/.config/nixos/nix/env.nix <<EOF
{
  username = "$TARGET_USER";
  hostname = "$TARGET_HOSTNAME";
  fullname = "$TARGET_FULLNAME";
  gituser = "$TARGET_GITUSER";
  gitemail = "$TARGET_GITEMAIL";
  folder = "vbg";
  imgbb = "";
}
EOF
echo "{ ... }: {}" >~/.config/nixos/nix/custom.nix
echo "{ ... }: {}" >~/.config/nixos/nix/custom-home.nix
rmdir ~/nixos ~/Desktop ~/Documents ~/Downloads ~/Music ~/Pictures ~/Public ~/Templates ~/Videos 2>/dev/null
rm ~/.config/user-dirs.dirs
echo "Getting hardware config..."
sudo mv /etc/nixos/hardware-configuration.nix ~/.config/nixos/nix/hardware.nix
echo "Removing old config..."
sudo rm -rf /etc/nixos/
echo "Options..."
# Initialize variables with defaults
ENABLE_FIREFOX=""
ENABLE_LIBVIRTD="false"
ENABLE_OPENSNITCH="false"

read -p "Set Extra Options? (y/N): " confirmop
if [[ "$confirmop" == "y" ]]; then
  read -p "Backup Firefox browser (in case Librewolf breaks) (y/N): " yesfirefox
  if [[ "$yesfirefox" == "y" ]]; then
    ENABLE_FIREFOX="firefox"
  fi

  read -p "Enable virtualization (libvirtd/KVM) (y/N): " yesvirt
  if [[ "$yesvirt" == "y" ]]; then
    ENABLE_LIBVIRTD="true"
  fi

  read -p "Enable OpenSnitch firewall (y/N): " yessnitch
  if [[ "$yessnitch" == "y" ]]; then
    ENABLE_OPENSNITCH="true"
  fi
fi

cat >~/.config/nixos/nix/options.nix <<EOF
{ pkgs, ... }:
{
  environment.systemPackages = with pkgs; [
    ${ENABLE_FIREFOX}
  ];

  virtualisation.libvirtd = {
    enable = ${ENABLE_LIBVIRTD};
    qemu = {
      package = pkgs.qemu_kvm;
    };
  };

  services.opensnitch = {
    enable = ${ENABLE_OPENSNITCH};
  };
}
EOF
echo 'Rebuilding NixOS...' && sudo nixos-rebuild switch --flake $HOME/.config/nixos/nix --impure --quiet --cores=$(nproc) --max-jobs=$(nproc) 2>/dev/null && echo Done!
chmod -R +x $HOME/.config/nixos/scripts/
echo "Cleaning up..."
nix-env -e git 2>/dev/null
clear
echo "Script complete. Reboot? (y/N)"
read rebootcon
if [ "$rebootcon" = "y" ]; then
  reboot
else
  echo "Skipping reboot."
  exit 0
fi
